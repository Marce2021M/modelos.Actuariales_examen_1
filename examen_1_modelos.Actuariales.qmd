---
title: "Modelos Actuariales"
subtitle: "Actuarial 3"
lang: es
author: "Marcelino Sánchez"
date: today
format:
  html:
    page-layout: full
    embed-resources: true
  pdf: 
     include-in-header:  
        - text: |
            \usepackage{actuarialsymbol}
     embed-resources: true
editor_options: 
  chunk_output_type: console
---


```{r, echo=FALSE, results=FALSE, warning=FALSE, message=FALSE}
# Cargamos la libreria
library(readxl)
library(ggplot2)
library(dplyr)
library(tidyverse)

# Supuestos principales
# 191654
# edad del asegurado
xEdad <- 16+30
#vigencia del seguro
n <- 19
#tasa de interes efectiva anual
itasaBase <- .05
#numero de primas anuales
mPrimas <- 4
# Sumas aseguradas
saMuerte <- 2000000
saSupervivencia <- 1000000

nCarteraAsegurados <- 100

# Leeremos la tabla de mortalidad

# Leemos la tabla de mortalidad
tablaMortalidad <- read_excel("Tabla_mortalidad.xlsx")

tablaMortalidad <- tablaMortalidad |> 
  mutate(dx= c(tablaMortalidad$lx[1:(length(tablaMortalidad$lx)-1)]-tablaMortalidad$lx[2:length(tablaMortalidad$lx)],NA))

qTablaMortalidad <- data.frame(px = numeric(length(tablaMortalidad$lx)-xEdad), kSuperv = numeric(length(tablaMortalidad$lx)-xEdad))


# Creamos la columna de supervivencia

for(i in (xEdad+1):length(tablaMortalidad$lx)){
  qTablaMortalidad$px[i-xEdad] <- tablaMortalidad$lx[i]/tablaMortalidad$lx[xEdad+1] 
  qTablaMortalidad$kSuperv[i-xEdad] <- i-xEdad
}

######-------------------------------------
#Gastos base

# Hacemos función de gastos extras

gastosExtrasPrimas <- function(anio){
  if(anio == 0){
    return(1000 + primaEmision*.4)
  }else if(anio %in% c(1,2)){
    return(500+.2*primaEmision)
  }else {
    return(100 + .05*primaEmision)
  }
}

gastosExtrasLiquidacion <- function(salida){
  if(salida == "muerte"){
    return(3000 + saMuerte*.003)
  }else{
    return(1000+saSupervivencia*.001)
}}

######-------------------------------------
#Regla de valores garantizados

# Hacemos función de valores garantizados

valoresGarantizados <- function(valorPoliza, anio){
  if(anio %in% c(1,2)){
    return(valorPoliza*.8)
  }else if (anio == 3){
    return(valorPoliza*.9)
  } else {
    return(0)
  }
}

######-------------------------------------
#Valores observados

valoresObservados_tasaInteres <- read_excel("Valores observados.xlsx", sheet="Observados Promedio", range="A3:B28")

valoresObservados_costosPromedios <- read_excel("Valores observados.xlsx", sheet="Observados Promedio", range="D3:G29")

valoresObservados_carteraObservados <- read_excel("Valores observados.xlsx", sheet="Cartera Observados", range="A1:C101")
```

# Nota Técnica

## 1. Descripción de la cobertura del seguro

### a. Tipo de seguro

Es un seguro dotal mixto.

### b. Temporalidad

El seguro tiene una vigencia de `r n` años con primas niveladas por 4 años anticipadamente.

### c. Población asegurada

La edad de los asegurados es de `r xEdad` años.

## 2. Hipótesis demográficas y financieras

### a. Hipótesis demográfica

Utilizaremos la tabla proporcionada por la aseguradora. La cual para una persona de `r xEdad` años se ve de la siguiente manera:

```{r,  echo=FALSE}
              
# Graficamos la tabla

ggplot(qTablaMortalidad, aes(x = kSuperv, y = px)) +
  geom_line() +
  geom_point() +
  labs(title = "Tabla de mortalidad", x = "Supervivencia", y = "px") 
```

### b. Hipótesis sobre costos

Dados los valores observados por la aseguradora tendremos los siguientes gastos.

Los gastos asociados a la prima son \$1000 más 40% de la prima en la emisión, \$500 más 20% de la prima los siguientes dos años y \$100 más 5% de la prima para el resto de los años donde se paga prima. Los gastos asociados a la liquidación son \$3,000 mas 0.3% de la suma asegurada en caso de muerte y \$1,000 mas 0.1% de la suma asegurada en caso de supervivencia.

### c. Hipótesis sobre tasa de interés

La tasa base será del `r itasaBase*100`%, porque actualmente existe la expectativa de disminución en la tasa de interés. Esto debido a que la inflación está disminuyendo, y la política de BM es bajar las tasas de interés una vez controlada la inflación. Además, como el seguro tiene una vigencia de `r n` años esperamos que disminuya aún más manteniendose en promedio del `r itasaBase*100`%.

## 3. Procedimientos técnicos

```{r echo=FALSE, results=FALSE}
# Funciones útiles para los siguientes cálculos

# Definición de más variables globales

v <- 1/(1+itasaBase)

# Cálculo de temporales

temporal <- function(edad, vigencia){
  resultado <- 0
  for (k in seq(0, vigencia-1, 1)){
    resultado <- resultado + v^(k+1)*(tablaMortalidad$dx[edad+k+1]/tablaMortalidad$lx[edad+1])
  }
  return(resultado)
}

anualidad <- function(edad, vigencia){
  resultado <- 0
  for (k in seq(0, vigencia-1, 1)){
    resultado <- resultado + v^(k)*(tablaMortalidad$lx[edad+k+1]/tablaMortalidad$lx[edad+1])
  }
  return(resultado)
}

dotal <- function(edad, vigencia){
  resultado <- v^(n)*tablaMortalidad$lx[xEdad+vigencia+1]/tablaMortalidad$lx[xEdad+1]
  return(resultado)
}

valorPoliza <- function(kTemp, prima){
  resultado <- 0
  if(kTemp %in% c(1,2,3,4)){
    resultado <- (dotal(xEdad,kTemp)^(-1))*(prima*anualidad(xEdad,kTemp)-saMuerte*temporal(xEdad, kTemp))
  } 
  else if(kTemp >=5 && kTemp<=n){
    resultado <- (dotal(xEdad,kTemp)^(-1))*(prima*anualidad(xEdad,4)-saMuerte*temporal(xEdad, kTemp))}
  else{
    resultado <- 0
  }
}

valorPolizaRecargado <- function(kTemp, primaRecargada){
  resultado <- 0
  if(kTemp == 1){
    resultado <- (dotal(xEdad,kTemp)^(-1))*(-1000+.6*primaRecargada-(3000+1.003*saMuerte)*temporal(xEdad, kTemp))
  } 
  else if(kTemp %in% c(2,3)){
    resultado <- (dotal(xEdad,kTemp)^(-1))*(-1000+.6*primaRecargada+(-500+.8*primaRecargada)*(anualidad(xEdad, kTemp)-1)-(3000+1.003*saMuerte)*temporal(xEdad, kTemp))
  }
  else if(kTemp >=4 && kTemp<=n){
    resultado <- (dotal(xEdad,kTemp)^(-1))*(-1000+.6*primaRecargada+(-500+.8*primaRecargada)*(anualidad(xEdad, 3)-1)+(-100+.95*primaRecargada)*anualidad(xEdad+3, mPrimas-3)*dotal(xEdad, 3)-(3000+1.003*saMuerte)*temporal(xEdad, kTemp))
  }
  else{
    resultado <- 0
  }
  return (resultado)
}


```


### a. Prima neta

(Fórmula para el cálculo y valor obtenido)

La prima neta está dada por la siguiente fórmula:

$$P=\frac{(SA_M)A_{`r xEdad`:\angl{`r n`}} +(SA_S) \Ex[`r n`]{`r xEdad`} }{\ddot{a}_{`r xEdad`:\angl{`r mPrimas`}}}$$

$$=\frac{(SA_M)(\sum_{k=0}^{`r n-1`}v^{k+1}\frac{\dx{`r xEdad`+k}}{\lx{`r xEdad`}})+(SA_S) v^{`r n`}\frac{\lx{`r xEdad + n`}}{\lx{`r xEdad`}}}{\sum_{k=0}^{`r n-1`}v^{k}\frac{\lx{`r xEdad`+k}}{\lx{`r xEdad`}}}$$

```{r echo=FALSE, results=FALSE}
# Cálculo de la prima neta

primaNeta <- (saMuerte*temporal(xEdad, n) + saSupervivencia*dotal(xEdad,n))/anualidad(xEdad, mPrimas)

```

Con lo cual el valor de la prima neta es de \$`r primaNeta`.

### b. Prima recargada

(Fórmula para el cálculo y valor obtenido)

El valor de la prima recargada proviene de despejar G de la siguiente ecuación:

$$(3000+(1.003)(SA_M))A_{\nthtop*{1}{`r xEdad`}:\angl{`r n`}} + (1000 + (1.001)(SA_S))\Ex[`r n`]{`r xEdad`}= $$

$$-1000+.6G+(-500+.8G)(\ax**{`r xEdad`:\angl{3}}-1)+(-100+.95G)\ax**{`r xEdad+3`:\angl{`r mPrimas-3`}}(\Ex[3]{`r n-3`})$$



Es decir, tenemos que:

$$G= \frac{(3000+(1.003)(SA_M))A_{\nthtop*{1}{`r xEdad`}:\angl{`r n`}} + (1000 + (1.001)(SA_S))\Ex[`r n`]{`r xEdad`}+1000+500((\ax**{`r xEdad`:\angl{3}}-1))+100(\ax**{`r xEdad+3`:\angl{`r mPrimas-3`}})(\Ex[3]{`r xEdad`})}{.6+.8(\ax**{`r xEdad`:\angl{3}}-1)+.95\ax**{`r xEdad+3`:\angl{`r mPrimas-3`}}(\Ex[3]{`r xEdad`})}$$



```{r echo=FALSE, results=FALSE}
# Cálculo de la prima recargada

primaRecargada <- ((3000+1.003*saMuerte)*temporal(xEdad, n) + (1000+1.001*saSupervivencia)*dotal(xEdad,n) + 1000 + 500*(anualidad(xEdad, 3)-1) + 100*anualidad(xEdad+3, mPrimas-3)*dotal(xEdad, 3))/(.6+.8*(anualidad(xEdad, 3)-1)+.95*anualidad(xEdad+3, mPrimas-3)*dotal(xEdad, 3))
```


Con lo cual el valor de la prima recargada es de \$`r primaRecargada`.

### c. Valores póliza asociados a la prima neta

(Fórmula para el cálculo y valores obtenidos para toda la vigencia de la póliza)

Para $k=0,...,4$
$$\Vx[k]{`r xEdad`: \angl{`r n`}}= \frac{1}{\Ex[k]{`r xEdad`}}(P\ax**{`r xEdad`:\angl{k}}-(SA_M)A_{\nthtop*{1}{`r xEdad`}:\angl{k}})$$

Para $k=5,...,`r n`$
$$\Vx[k]{`r xEdad`: \angl{`r n`}}= \frac{1}{\Ex[k]{`r xEdad`}}(P\ax**{`r xEdad`:\angl{4}}-(SA_M)A_{\nthtop*{1}{`r xEdad`}:\angl{k}})$$



```{r echo=FALSE}
# Cálculo de valores póliza asociados

# Creamos la tabla de valores póliza asociados a la prima neta

tablaValoresPolizaAsociados <- data.frame(k = numeric(n+1), Vx = numeric(n+1))

# Llenamos la tabla

for (k in seq(0, n, 1)){
  tablaValoresPolizaAsociados$Vx[k+1] <- valorPoliza(k, primaNeta)
  tablaValoresPolizaAsociados$k[k+1] <- k
}

#Mostramos la tabla

tablaValoresPolizaAsociados 


# Graficamos la tabla

ggplot(tablaValoresPolizaAsociados, aes(x = k, y = Vx)) +
  geom_line() +
  geom_point() +
  labs(title = "Valores póliza asociados a la prima neta", x = "k", y = "Vx") 

```

### d. Valores póliza asociados a la prima recargada

(Fórmula para el cálculo y valores obtenidos para toda la vigencia de la póliza)

Para $k=1$

$$\Vx[k]{`r xEdad`: \angl{`r n`}}= \frac{1}{\Ex[k]{`r xEdad`}}(-1000+.6G-(3000+1.003SA_M)A_{\nthtop*{1}{`r xEdad`}:\angl{k}})$$

Para $k=2,3$

$$\Vx[k]{`r xEdad`: \angl{`r n`}}= \frac{1}{\Ex[k]{`r xEdad`}}(-1000+.6G+(-500+.8G)(\ax**{`r xEdad`:\angl{k}}-1)-(3000+1.003SA_M)A_{\nthtop*{1}{`r xEdad`}:\angl{k}})$$


Para $k=4,...,`r n`$

$$\Vx[k]{`r xEdad`: \angl{`r n`}}= \frac{1}{\Ex[k]{`r xEdad`}}(-1000+.6G+(-500+.8G)(\ax**{`r xEdad`:\angl{3}}-1)+(-100+.95G)(\ax**{`r xEdad+3`:\angl{`r mPrimas-3`}})(\Ex[3]{`r xEdad`})$$
$$-(3000+1.003SA_M)A_{\nthtop*{1}{`r xEdad`}:\angl{k}})$$


```{r echo=FALSE}

# Creamos la tabla de valores póliza asociados a la prima recargada

tablaValoresPolizaAsociadosRecargada <- data.frame(k = numeric(n+1), Vx = numeric(n+1))

# Llenamos la tabla

for (k in seq(0, n, 1)){
  tablaValoresPolizaAsociadosRecargada$Vx[k+1] <- valorPolizaRecargado(k, primaRecargada)
  tablaValoresPolizaAsociadosRecargada$k[k+1] <- k
}

#Mostramos la tabla

tablaValoresPolizaAsociadosRecargada


# Graficamos la tabla

ggplot(tablaValoresPolizaAsociadosRecargada, aes(x = k, y = Vx)) +
  geom_line() +
  geom_point() +
  labs(title = "Valores póliza asociados a la prima recargada", x = "k", y = "Vx") 

```




### e. Valores garantizados

(Fórmula para el cálculo y valores obtenidos mientras haya pago de primas)

Calculado retrospectivamente obtenemos la siguiente fórmula:

```{r echo=FALSE}
# Creamos la tabla de valores garantizados

tablaValoresGarantizados <- data.frame(k = numeric(3), Vx = numeric(3))

# Llenamos la tabla

for (k in seq(1, 3, 1)){
  tablaValoresGarantizados$Vx[k] <- valoresGarantizados(valorPoliza(k, primaNeta), k)
  tablaValoresGarantizados$k[k] <- k
}

#Mostramos la tabla

tablaValoresGarantizados


# Graficamos la tabla

ggplot(tablaValoresGarantizados, aes(x = k, y = Vx)) +
  geom_line() +
  geom_point() +
  labs(title = "Valores garantizados", x = "k", y = "Vx") 

```

# Profit testing

## 1. Análisis determinista

```{r, echo=F, results=F}
iTasaEstimada <- .05
tablaMortalidadEstimada <- tablaMortalidad

gastoPropPrima <- function(kTemp){
  #Es el complemento del ejerccio por cómo está configurado
  if(kTemp==1){
    resultado <- .6
  } else if(kTemp %in% c(2,3)){
    resultado <- .8
  }else if(kTemp>=4){
    resultado <- .95
  }
  return(resultado)
}
gastoFijoPrima <- function(kTemp){
    if(kTemp==1){
    resultado <- 1000
  } else if(kTemp %in% c(2,3)){
    resultado <- 500
  }else if(kTemp>=4){
    resultado <- 100
  }
  return(resultado)
}

desembolsoProp <- function(salida="Muerte"){
  if(salida =="Muerte"){
    resultado <- 1.003
  } else {
    resultado <- 1.001
  }
  return(resultado)
}
desembolsoFijo <- function(salida="Muerte"){
  if(salida =="Muerte"){
    resultado <- 3000
  } else {
    resultado <- 1000
  }
  return(resultado)
}


flujos_utilidad <- function(kTemp){
  #ktemo solo está entre 1 a n
  if (kTemp %in% c(1,2,3,4)){
    ingreso <- (gastoPropPrima(kTemp)*primaRecargada-gastoFijoPrima(kTemp) + tablaValoresPolizaAsociadosRecargada$Vx[kTemp])*(1+iTasaEstimada)*tablaMortalidadEstimada$lx[xEdad+kTemp]} 
    else {
    ingreso <- tablaValoresPolizaAsociadosRecargada$Vx[kTemp]*(1+iTasaEstimada)*tablaMortalidadEstimada$lx[xEdad+kTemp]
    }
    egreso <-(desembolsoFijo()+desembolsoProp()*saMuerte)*tablaMortalidadEstimada$dx[xEdad+kTemp]
    reserva <- tablaValoresPolizaAsociadosRecargada$Vx[kTemp+1]*tablaMortalidadEstimada$lx[xEdad+kTemp+1]
    resultado <- 1000*(ingreso-egreso-reserva)/tablaMortalidadEstimada$lx[xEdad+1]
    return(resultado)
}
```

### a. Hipótesis demográ ficas y financieras

(Elige las variables a analizar, mínimo 2, y los supuestos realistas que vas a utilizar)

Vamos a analizar las variables de tasa de interés y de tabla de mortalidad y sus efectos en las medidas de VPN y MU. 

Nuestro mejor estimador de estas variables es que la tasa de interés con la que traeremos a valor presente todos los flujos será de 7.5%, porque se espera que las tasas  de interés bajen paulatinamente y considerando que actualmente nos encontramos con tasas altísimas del 11% aproximadamente.(CHECAR)

Así mismo consideramos que la tabla de mortalidad será ______(CHECAR), esto porque somos conservadores y seguimos la tabla de mortalidad presentada por ________. (CHECAR)

### b. Valor Presente Neto (VPN)

(Fórmula para el cálculo y valor obtenido)

$$VPN = \sum_{i=1}^{19}F_{k}v^{k}$$

donde $F_{k}$ representa los flujos vencidos de cada año (solo durante ese año) hasta la vigencia, tomando en cuenta el final de la vigencia. Tomamos en cuenta que estos flujos son invertidos a la tasa que estimamos anteriormente y previstos con la tabla de mortalidad antes mencioanda. Así mismo, aclaramos que todos los cálculos actuariales provienen de los cálculos base.

Con lo cual 

```{r, echo=F}
medidaVPN <- function(){
  resultado <- 0
  for (kTemp in seq(1,n,1)){
    resultado <- resultado + flujos_utilidad(kTemp)*v^(kTemp)
  }
  return(resultado)
}

medidaVPN()
```


### c. Margen de Utilidad (MU)

(Fórmula para el cálculo y valor obtenido)



```{r}

```

## 2. Análisis estocástico

### a. Análisis stress-testing para el VPN y MU

(Escoge 2 variables y realiza el stress testing)

```{r}

```

### b. Análisis por escenarios para el VPN y MU

(Plantea 5 escenarios para realizar el análisis)

```{r}

```

### c. Análisis por simulación

#### c.1. Hipótesis para la simulación de las variables a analizar

#### c.2. Histograma de 1000 realizaciones de VPN y MU

#### c.3. Promedio y desviación estándar de las 1000 realizaciones de VPN y MU

# Para una cartera de 100 asegurados: Fondo Total

## 1. Asset-share

(Fórmula para el cálculo y valores obtenidos para toda la vigencia de la póliza)

## 2. Estimación del Fondo Total mediante el Asset-share

(Fórmula para el cálculo y valores obtenidos para toda la vigencia de la póliza)

# Análisis de Rentabilidad

## 1. Utilidades

(Fórmula para el cálculo y valores obtenidos para toda la vigencia de la póliza)

## 2. VPN

(Fórmula para el cálculo y valor obtenido)

## 3. MU

(Fórmula para el cálculo y valor obtenido)